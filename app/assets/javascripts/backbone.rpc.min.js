/*
 * Copyright (c) 2012 @asciidisco <public@asciidisco.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files (the "Software"), 
 * to deal in the Software without restriction, including without limitation 
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 * and/or sell copies of the Software, and to permit persons to whom the 
 * Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, 
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS 
 * IN THE SOFTWARE.
 */// Backbone.Rpc
// Plugin for using the backbone js library with a remote json-rpc handler
// instead of the default REST one
(function(a,b,c){typeof exports=="object"?module.exports=b(require("underscore"),require("backbone"),require("jquery")):typeof define=="function"&&define.amd?define(["underscore","backbone","jquery"],function(d,e,f){return d=d===c?a._:d,e=e===c?a.Backbone:e,f=f===c?a.$:f,a.returnExportsGlobal=b(d,e,f)}):a.returnExportsGlobal=b(a._,a.Backbone,a.$)})(this,function(a,b,c,d){var e=function(b){this.options=b!==d?b:{},this.namespaceDelimiter=b!==d&&b.namespaceDelimiter!==d?b.namespaceDelimiter:this.namespaceDelimiter,a.bindAll(this)},f=b.Model.prototype.constructor,g=b.sync,h={};return e.prototype={options:{},charset:"iso-8859-1",namespace:"",namespaceDelimiter:"/",url:null,responseID:null,exceptions:{404:{code:-1,message:"404"},500:{code:-2,message:"500"},typeMissmatch:{code:-3,message:"Type missmatch"},badResponseId:{code:-4,message:"Bad response ID"},noResponse:{code:-5,message:"No response"},noDefError:{code:-6,message:"No error defined"},renderError:function(a,b){return{code:b!==d?-7:b,message:a?"No error defined":a}}},onSuccess:function(b,c,e,f,g){if(a.isFunction(b)===!0){if(e===null||e===d)return this.handleExceptions(this.exceptions.noResponse),this;e!==null&&c!==String(e.id)&&this.handleExceptions(this.exceptions.badResponseId),b.apply(this,[e.result,e.error])}else this.onError(e)},onError:function(a,b,c,e){if(b===null||b===d)return this.handleExceptions(this.exceptions.noResponse),this;null!==b.error&&d!==b.error?this.handleExceptions(b.error):this.handleExceptions(this.exceptions.noDefError)},query:function(b,e,f,g){var h=String((new Date).getTime());return this.responseID=h,a.isArray(e)&&a.isString(b)?c.ajax({contentType:"application/x-www-form-urlencoded; charset="+this.charset,type:"POST",dataType:"json",url:this.url,data:JSON.stringify({jsonrpc:"2.0",method:this.namespace+this.namespaceDelimiter+b,id:h,params:e}),statusCode:{404:a.bind(function(){this.handleExceptions(this.exceptions[404])},this),500:a.bind(function(){this.handleExceptions(this.exceptions[500])},this)},success:a.bind(function(a,b,c){a!==null&&a.error!==d?this.onError(f,a,b,c):this.onSuccess(f,h,a,b,c)},this),error:a.bind(function(a,b,c){a.status!==404&&a.status!==500&&this.onError(f,a,b,c)},this)}):this.handleExceptions(this.exceptions.typeMissmatch)},checkMethods:function(b,c,e,f,g,i,j){var k=null,l=!1,m=null,n=[],o={};f=f==="delete"?"remove":f;if(!a.isArray(e.methods[f])&&!a.isFunction(e.methods[f]))return this.handleExceptions(this.exceptions.typeMissmatch);a.isFunction(e.methods[f])?(a.isString(h[e.get("_rpcId")])||a.each(h[e.get("_rpcId")],function(a,b){e.get(b)!==a&&(o[b]=!0)}),h[e.get("_rpcId")]=e.toJSON(),k=e.methods[f](o,g)):k=e.methods[f],a.isArray(k[0])&&(l=!0);if(l!==!0){var p=a.clone(k);return m=p.shift(),p.length>0?a.each(p,function(a){a===""?n.push(""):e.get(a)!==d?n.push(e.get(a)):g[a]!==d&&n.push(g[a])}):n=[],b(m,n,i,j)}return a.each(k,function(c){var d=a.clone(c);return m=null,n=[],m=d.shift(),a.each(d,function(a){n.push(e.get(a))}),b(m,n,i,j)}),null},invoke:function(c,e,f){var g={success:function(b){e.trigger("called:"+c,e,b),f!==d&&a.isFunction(f.success)&&f.success(e,b)},error:function(b,e){b.trigger("error",b,e),b.trigger("error:"+c,b,e),f!==d&&a.isFunction(f.error)&&f.error(b,e)}};return b.sync(c,e,g),this},defaultExceptionHandler:function(a){throw"Error code: "+a.code+" - message: "+a.message},handleExceptions:function(b){var c=a.isFunction(this.options.exceptionHandler)?this.options.exceptionHandler:this.defaultExceptionHandler;return c.call(this,b),this}},b.Rpc=e,b.Model=b.Model.extend({constructor:function(b){this.rpc!==d&&a.isFunction(this.rpc.invoke)===!0&&this.methods!==d&&a.each(this.methods,a.bind(function(b,c){(({read:1,create:1,remove:1,update:1}))[c]!==1&&(this[c]=a.bind(function(a){return this.rpc.invoke(c,this,a),this},this))},this)),f.apply(this,arguments)}}),b.sync=function(c){var e=function(e,f,g){var i=function(c,i){if(i!==null&&i!==d)return g.error(f,i),this;f instanceof b.Collection&&c!==d&&c!==null&&(typeof c[0]=="object"?a.each(c,function(b,d){b._rpcId=a.uniqueId("rpc_"),c[d]=b,h[b._rpcId]=b}):a.each(c,function(a,b){h[b]=a})),f instanceof b.Model&&c!==d&&c!==null&&(c._rpcId=a.uniqueId("rpc_"),h[c._rpcId]=c);if(c===d||c===null)c=[];f.parsers!==d&&f.parsers[e]!==d&&a.isFunction(f.parsers[e])&&f.parsers[e].apply(f,[c]),g.success(c)},j=function(a){g.error(f,a)};if(f.rpc instanceof c){rpc=f.rpc,rpc.url=a.isFunction(f.url)?f.url():f.url,a.isString(f.namespace)===!0&&(rpc.namespace=f.namespace);if(f.methods===d)throw"Backbone.Rpc Error: No Method(s) given!";return typeof f.params!="object"&&(f.params={}),rpc.checkMethods(rpc.query,f.params,f,e,g,i,j)}return null};return e.previous=g,e}(e),b});